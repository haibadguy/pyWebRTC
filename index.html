<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Signaling</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
    <h1>WebRTC Signaling Server</h1>
    <script>
        // Cấu hình peer connection
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }  // STUN server của Google
            ]
        };

        let peerConnection;
        let iceCandidates = [];

        // Khởi tạo peerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // Gửi ICE candidate tới server khi tìm thấy
                    socket.emit('candidate', event.candidate);
                }
            };

            peerConnection.oniceconnectionstatechange = async () => {
                if (peerConnection.iceConnectionState === 'connected') {
                    // Nếu đã kết nối ICE, thêm tất cả candidate đã queue lại
                    for (let candidate of iceCandidates) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                    iceCandidates = [];
                }
            };
        }

        // Lắng nghe sự kiện "offer" từ server
        socket.on('offer', async (offer) => {
            if (offer && offer.sdp) {
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    console.log("Remote description set successfully");

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    // Gửi answer lại server
                    socket.emit('answer', {
                        type: 'answer',
                        sdp: answer.sdp
                    });
                } catch (e) {
                    console.error('Error setting remote description:', e);
                }
            } else {
                console.error('Invalid offer received:', offer);
            }
        });

        // Lắng nghe sự kiện "candidate" từ server
        socket.on('candidate', async (candidate) => {
            if (peerConnection.remoteDescription) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } else {
                iceCandidates.push(candidate);  // Nếu chưa có remote description, thêm candidate vào queue
            }
        });

        // Khởi tạo kết nối WebSocket
        const socket = io('https://your-server-url');  // Thay bằng URL của server Flask của bạn

        // Lắng nghe sự kiện kết nối
        socket.on('connect', () => {
            console.log("Connected to signaling server");
            createPeerConnection();
        });

        // Lắng nghe các tin nhắn khác từ server
        socket.on('message', (message) => {
            console.log(message);
        });
    </script>
</body>
</html>
