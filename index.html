<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Signaling</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>

<body>
    <h1>WebRTC Signaling Server</h1>
    <script>
        // Configuration for peer connection
        const configuration = {
            iceServers: [{
                    urls: 'stun:stun.l.google.com:19302'
                } // Google STUN server
            ]
        };

        let peerConnection;
        let iceCandidates = [];

        // Initialize peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // Send ICE candidate to the server
                    socket.emit('candidate', event.candidate);
                }
            };

            peerConnection.oniceconnectionstatechange = async () => {
                if (peerConnection.iceConnectionState === 'connected') {
                    // Add all queued candidates after ICE connection is established
                    for (let candidate of iceCandidates) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                    iceCandidates = [];
                }
            };
        }

        // Listen to the 'offer' event from the server
        socket.on('offer', async (offer) => {
            if (offer && offer.sdp) {
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    console.log("Remote description set successfully");

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    // Send answer back to the server
                    socket.emit('answer', {
                        type: 'answer',
                        sdp: answer.sdp
                    });
                } catch (e) {
                    console.error('Error setting remote description:', e);
                }
            } else {
                console.error('Invalid offer received:', offer);
            }
        });

        // Listen to the 'candidate' event from the server
        socket.on('candidate', async (candidate) => {
            if (peerConnection.remoteDescription) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } else {
                iceCandidates.push(candidate); // Queue the candidate if remote description is not set yet
            }
        });

        // Initialize WebSocket connection
        const socket = io('https://pywebrtc.onrender.com'); // Replace with your Render app URL

        // Handle connection to signaling server
        socket.on('connect', () => {
            console.log("Connected to signaling server");
            createPeerConnection();
        });

        // Handle other messages from the server
        socket.on('message', (message) => {
            console.log(message);
        });
    </script>
</body>

</html>
