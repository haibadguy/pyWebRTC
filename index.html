<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        video {
            width: 45%;
            margin: 5px;
        }

        #controls {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>WebRTC Video Call</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <div id="controls">
        <button id="startCall">Start Call</button>
        <button id="endCall">End Call</button>
    </div>

    <script>
        const socket = new WebSocket("wss://pywebrtc.onrender.com/");

        let peerConnection = null;
        let localStream = null;

        // Lấy stream từ camera và microphone
        async function startCall() {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            document.getElementById('localVideo').srcObject = localStream;

            peerConnection = new RTCPeerConnection();
            peerConnection.addEventListener('icecandidate', handleICECandidate);
            peerConnection.addEventListener('track', handleRemoteStream);

            // Thêm các track vào PeerConnection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Tạo offer và gửi qua WebSocket
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.send(JSON.stringify({
                type: 'offer',
                sdp: offer.sdp
            }));
        }

        // Khi nhận được remote stream, hiển thị nó
        function handleRemoteStream(event) {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
        }

        // Khi nhận được ICE candidate từ server, thêm vào PeerConnection
        function handleICECandidate(event) {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: 'candidate',
                    candidate: event.candidate
                }));
            }
        }

        // Khi nhận được message từ WebSocket
        socket.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'answer') {
                // Đặt remote description khi nhận được answer từ server
                await peerConnection.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer',
                    sdp: message.sdp
                }));
            } else if (message.type === 'candidate') {
                // Thêm ICE candidate
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        };

        // Điều khiển start và end cuộc gọi
        document.getElementById('startCall').addEventListener('click', startCall);
        document.getElementById('endCall').addEventListener('click', () => {
            peerConnection.close();
            peerConnection = null;
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        });
    </script>
</body>

</html>
